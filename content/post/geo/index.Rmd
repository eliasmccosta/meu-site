---
title: Geoestat√≠stica aplicada a agricultura de precis√£o
author:
  - admin
date: 'r Sys.Date()'
slug: geo
categories:
  - R
  - Programa√ß√£o
  - Geoestat√≠stica
tags:
  - Agricultura de Precis√£o
  - Mapping
  - Geoestat√≠stica
  - DSM
subtitle: 'Geoestat√≠stica aplicada ao mapeamento da fertilidade do solo'
summary: 'Um exemplo de aplica√ß√£o de geoestat√≠stica usando o R'
authors: []
lastmod: '2022-08-20T12:22:36-03:00'
featured: no
draft: no
image:
  caption: 'Image credit: [**Elias**](https://www.instagram.com/eliasmendescosta/)'
  focal_point: ""
  placement: 3
  preview_only: no
math: true
projects:
  - Bahia
bibliography: references.bib
csl: geoderma-regional.csl
---
```{r, eval=FALSE, echo=FALSE}
rmarkdown::render('index.Rmd', encoding = 'UTF-8'")
```

# Introdu√ß√£o

A geoestat√≠stica como conhecemos hoje come√ßou com os trabalhos de @Krige1951. Para ele somente a informa√ß√£o dada pela vari√¢ncia n√£o seria suficiente para explicar o fen√¥meno em estudo. Para tal, seria necess√°rio levar em considera√ß√£o a dist√¢ncia entre as observa√ß√µes. A partir da√≠ surge o conceito da `geoestat√≠stica`, que leva em considera√ß√£o a `localiza√ß√£o geogr√°fica` e a `depend√™ncia espacial` entre amostras. 
@Matheron1963 e @Matheron1971 , baseado-se nas observa√ß√µes de Krige, desenvolveu a teoria das `vari√°veis regionalizadas`. Uma vari√°vel regionalizada √© uma fun√ß√£o num√©rica com distribui√ß√£o espacial, que varia de um ponto a outro com continuidade aparente, mas cujas varia√ß√µes n√£o podem ser representadas por uma fun√ß√£o matem√°tica simples.
A teoria das vari√°veis regionalizadas pressup√µe que a varia√ß√£o de uma vari√°vel pode ser expressa pela soma de tr√™s componentes: a) uma componente estrutural, associada a um valor m√©dio constante ou a uma tend√™ncia constante; b) uma componente aleat√≥ria, espacialmente correlacionada; e c) um ru√≠do aleat√≥rio ou erro residual.
Assim um valor da vari√°vel Z em um local x √© dado por:

$$ Z(x)=m(x)+\varepsilon‚Ä≤(x)+\varepsilon‚Ä≤‚Ä≤ $$
onde: m(**x**) √© uma fun√ß√£o determin√≠stica que descreve a componente estrutural de Z
em x; Œµ‚Ä≤(**x**) √© um termo estoc√°stico, que varia localmente e depende espacialmente de
m(**x**); Œµ‚Ä≤‚Ä≤ √© um ru√≠do aleat√≥rio n√£o correlacionado, com distribui√ß√£o normal com
m√©dia zero e vari√¢ncia œÉ2

Um dos modelos mais simplistas dessa varia√ß√£o √© o calculado pelo `inverso do quadrado da dist√¢ncia` que assume que qualquer atributo do solo varia a taxa fixa do inverso da dist√¢ncia, o que na pr√°tica n√£o √© bem verdade, mas em muitos casos esse modelo atende a necessidade. 

## Variograma
O variograma √© uma ferramenta b√°sica de suporte √†s t√©cnicas de krigagem, que permite representar quantitativamente a varia√ß√£o de um fen√¥meno regionalizado no espa√ßo. Considere duas vari√°veis regionalizadas, X e Y, onde X = Z(x) e Y = Z(x+h). Neste caso, referem-se ao mesmo atributo medido em duas posi√ß√µes diferentes.

O n√≠vel de depend√™ncia entre essas duas vari√°veis regionalizadas, X e Y, √© representado pelo variograma, 2Œ≥(**h**), o qual √© definido como a esperan√ßa matem√°tica do quadrado da diferen√ßa entre os valores de pontos no espa√ßo, separados pelo vetor dist√¢ncia **h**, isto √©,

$$ 2Œ≥(h) = E{[Z(x)-Z(x+h)] 2 } = Var[Z(x)-Z(x+h)]$$
Atrav√©s de uma amostra z(x i ), i=1, 2, /home/elias/MEGA/Geo., n, o variograma pode ser estimado por

$$ 2≈∂(h)=\frac{1}{N(h)}\sum^{N(h)}_{i=1}[Z(x_i)-Z(X_i+h)]¬≤$$
onde:
- 2≈∂(**h**) - √© o variograma estimado;
- N(h) - √© o n√∫mero de pares de valores medidos, z(**xi**) e z(**xi+h**), separados por um vetor dist√¢ncia **h**;
- z(xi) e z(xi +h), - s√£o valores da i-√©sima observa√ß√£o da vari√°vel regionalizada, coletados nos pontos **xi** e **xi+h** (i = 1, /home/elias/MEGA/Geo., n), separados pelo vetor **h**.

## Par√¢metros do semivariograma
O seu padr√£o representa o que, intuitivamente, se espera de dados de campo, isto √©, que as diferen√ßas {Z(**xi**) - Z(**xi+h**)} decres√ßam √† medida que **h**, a dist√¢ncia que os separa decresce. √â esperado que observa√ß√µes mais pr√≥ximas geograficamente tenham um comportamento mais semelhante entre si do que aquelas separadas por maiores dist√¢ncias. Desta maneira, √© esperado que Œ≥(**h**) aumente com a dist√¢ncia **h**.

```{r variogram, echo=FALSE,message=FALSE, warning=FALSE, fig.cap= "Exemplo de Semivariograma.",fig.align='center', dpi=50, fig.asp=1}
knitr::include_graphics("semivariograma.png")
```
- Alcance (a) (range): dist√¢ncia dentro da qual as amostras apresentam-se correlacionadas espacialmente. 
- Patamar (C) (sill): √© o valor do semivariograma correspondente a seu alcance (a).Deste ponto em diante, considera-se que n√£o existe mais depend√™ncia espacial entre as amostras, porque a vari√¢ncia da diferen√ßa entre pares de amostras (Var[Z(**x**) - Z(**x+h**)]) torna-se invariante com a dist√¢ncia. Pode ser definido tamb√©m como vari√¢ncia total.
- Efeito Pepita (C0)(nugget): A medida que **h** tende para 0 (zero), g(**h**) se aproxima de um valor positivo chamado Efeito Pepita (C0), que revela a descontinuidade do semivariograma para dist√¢ncias menores do que a menor dist√¢ncia entre as amostras, pode ser definido tamb√©m como vari√¢ncia residual. 

## Estrutura espacial local
Se consideramos as coordenadas de cada ponto √© poss√≠vel obervar uma tend√™ncia regional ou uma estrutura local dos dados, umas das formas mais simples de observar a depend√™ncia espacial √© atraves de plot espacial dos valores observados.

Agora analisamos a ideia de depend√™ncia espacial local: ‚Äúmais perto no espa√ßo geogr√°fico implica mais perto no espa√ßo de atributos‚Äù. Isso pode ser verdade ou n√£o;e se for verdade, o intervalo de depend√™ncia ir√° variar, dependendo do processo f√≠sico que produziu o atributo que est√° sendo investigado, nesse caso o teor de argila do solo.
O conceito fundamental √© que deve ser entendido nesse contexto √© a `autocorrela√ß√£o espacial`: um valor de atributo pode ser correlacionado consigo mesmo, com a for√ßa da correla√ß√£o dependendo da dist√¢ncia de separa√ß√£o (e possivelmente na dire√ß√£o). Isso deve ser evidente como uma rela√ß√£o entre a dist√¢ncia de separa√ß√£o e correla√ß√£o; para an√°lisar essas rela√ß√µes usamos o conceito de `semivari√¢ncia` como j√° mencionado quando apresentado o semivariograma.Esse an√°lise √© feita com base no n√∫mero de pares poss√≠veis do dataset que pode ser determinado por (n √ó (n - 1))/2 pares.

Quando fazemos o variograma experimental dos teores de COT, √© calculado as semivari√¢ncias *m√©dias* dos pares de pontos versus dist√¢ncia *m√©dia*(tamb√©m conhecido como "lag"), com cumprimento definido pelo usu√°rio, e dist√¢ncia m√°xima de busca *cutoff*. 


## Modelos te√≥ricos
Selecionar uma forma de modelo √© uma arte; a melhor maneira √© a partir do conhecimento do processo espacial e da forma como o modelo se ajusta ao semivariograma esperimental. 
A fun√ß√£o vgm especifica um modelo de variograma. No conjunto anterior n√≥s estimamos esses par√¢metros observando o variograma emp√≠rico, ent√£o os fornecemos como par√¢metros do modelo. Observe que para cada modelo h√° um conjunto de par√¢metro que melhor se ajusta. Para fins de exemplo vamos testar os 3 principais modelos, neles teremos que ajustar o "parcial sill" (contribui√ß√£o) `psill` que √© o patamar menos o efeito pepita (nugget) e o alcance (range)
Poss√≠veis modelos no pacote `gstat`
```{r, include=T, warning=FALSE}
library(gstat)
library(sp)
library(readxl)
library(tmap)
library(raster)
print(show.vgms())
```

```{r, lendo e plotando os dados}
data <- read_excel("/home/elias/MEGA/Geo/data/An√°lises.xls", 
                       col_types = c("numeric", "numeric", "numeric", 
                                     "numeric", "numeric", "numeric", 
                                     "numeric", "numeric", "numeric", 
                                     "numeric"))

## Definindo o sistema de projeto do conjunto de dados
WGS23S  = sp::CRS("+proj=utm +zone=23 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0")

## Transformando o dataframe "data" em informa√ß√£o espacial
coordinates(data) = ~X+Y
sp::proj4string(data) = WGS23S ## Definindo sistema de coordenadas para os DADOS

plot(data)

## Carregando arquivo raster para uso como grid de refer?ncia na interpola√ß√£o
raster=raster::brick("/home/elias/MEGA/Geo/raster/mosaico.tif")
#plotRGB(raster, 1, 2, 3)
sp::proj4string(raster) = WGS23S 
#raster=projectRaster(raster, crs = WGS23S)
#plot(raster)
## Transformando o arquivo "raster" em arquivo "SpatialPixelsDataFrame" para posterior uso como grid de refer√™ncia
grid=as(raster, "SpatialPixelsDataFrame")

############### Analisando de forma qualitativa a deped√™ncia espacial)
plot(data, asp=1, cex=4*data$ADT/max(data$ADT), pch=1)

#############
# Aqui vamos ver de forma detalhada e did√°tica (passo a passo) da avalia√ß√£o de deped√™ncia espacial. Na pr√°tica n√£o h√° necessidade de seguir todos esses passos. 

n <- length(data$COT) # comprimento do conjunto de dados
n*(n-1)/2  ## Calculando o n√∫mero de pares de pontos

# Agora como exerc√≠cio vamos calcular a semivari√¢ncia entre os dois primeiros pontos do dataset
coordinates(data)[1,] # linha 1
coordinates(data)[2,] # linha 2
sep <- dist(coordinates(data)[1:2,]) # dist√¢ncia entre o ponto 1 e ponto 2
gamma <- 0.5 * (data$ADT[1] - data$ADT[2])^2 # semivari√¢ncia entre o ponto 1 e ponto 2

max(dist(data@coords))*2/3 # M√°xima dist√¢ncia entre os pontos, para limitar a dist√¢ncia do variograma em 2/3 da M√°xima dist√¢ncia
min(dist(data@coords)) # minima dist√¢ncia entre pontos, ajuda a definir o tamanho do lag

# Variograma de n√∫vem
variograma <- gstat::variogram(COT ~ 1, data, cloud = TRUE, cutoff = Inf)
plot(variograma, ylab = "semivari√¢ncia", xlab = "dist√¢ncia (m)")

# Variograma experimental
v <- variogram(COT ~ 1, data, cutoff=90, width=7)
print(plot(v, plot.numbers=F))
# width √© o tamanho do lag (passo), ou seja, um ponto m√©dio (uma simplifica√ß√£o) a cada 1800 m
# Cutoff = dist√¢ncia M√°xima de busca que a gente viu em 2/3 √© em torno de 70000 m, mas vimos que uma dist√¢ncia mais curta √© melhor ent√£o usamos 11000


####### Alguns exemplos de poss√≠veis modelos dispon√≠veis em R #####
print(show.vgms())

### Modelo esf√©rico
vm1 <- vgm(psill=15, model="Sph",range=40,nugget=0)
print(plot(v, pl=F, model=vm1, main = "Esf√©rico"))


### Modelo Exponencial
vm2 <- vgm(psill=15, model="Exp",range=15,nugget=0)
print(plot(v, pl=F, model=vm2))


### Modelo Gaussiano
vm3 <- vgm(psill=16, model="Gau",range=20,nugget=0)
print(plot(v, pl=F, model=vm3))

# Modelo Ajustado esf√©rico
(vmf1 <- fit.variogram(v, vm1))
print(plot(v, pl=F, model=vmf1))

# Modelo Ajustado Exponencial
(vmf2 <- fit.variogram(v, vm2))
print(plot(v, pl=F, model=vmf2))

# Modelo Gaussiano
(vmf3 <- fit.variogram(v, vm3))
print(plot(v, pl=F, model=vmf3))
```
# krigagem
Agora usamos a estrutura espacial para interpolar "de forma otimizada" para os locais n√£o amostrados. Existem muitas maneiras de interpolar; vamos primeiro investigar a krigagem ordin√°ria.
O que h√° de t√£o especial na krigagem?
‚Ä¢ Prev√™ em qualquer ponto como a m√©dia ponderada dos valores em pontos n√£o amostrados
‚Ä¢ Os pesos dados a cada ponto da amostra s√£o √≥timos, dado a estrutura de covari√¢ncia, conforme revelado pelo modelo de variograma (neste sentido o que √© ‚Äúmelhor‚Äù se ajutou)
‚Ä¢ A varia√ß√£o de krigagem em cada ponto √© gerada automaticamente como parte do processo de c√°lculo dos pesos.

## Krigagem ordin√°ria
Antes de fazer as predi√ß√µes nos grids para gera√ß√£o dos mapas vamos fazer as predi√ß√µes no conjunto de dados de valida√ß√£o para avaliar o desempenho dos modelos. 

```{r, kriging}
### Krigando no grid para gera√ß√£o do mapa
## Carregando o limite da √°rea no formato shapefile
limite <- maptools::readShapeSpatial("/home/elias/MEGA/Geo/shape/limite.shp", 
                                     proj4string=WGS23S, verbose=TRUE)
### Predic√£o Exp
grid <- krige(COT ~ 1, locations=data, newdata=grid, model=vm3)
grid <- raster::stack(grid)
grid = raster::mask(grid, limite)
raster = raster::mask(raster, limite)

tm_shape(limite)+
  tm_polygons(col = "lightgrey")+
  tm_shape(data) +
  tm_symbols(col = "COT", palette = 'YlOrRd', size = "COT", scale = 1.5,
             legend.size.show = F,    # comment this line to see the original size legend
             legend.col.show = T,     # comment this line to see the original color legend
             title.col="AWC (mm)") +
  tm_compass(position = c("center", "top"), size=4) +
  tm_grid(alpha = 0.2, labels.size = 1, labels.rot = c(0,90), n.x=5, n.y=6) + 
  tm_scale_bar(position = c("right", "bottom"), text.size =1) +
  tm_layout(title = "", legend.position = c("left", "top"), main.title.position = 'center', legend.text.size = 1)



tm_shape(grid$var1.pred) +
  tm_raster(title = "COT (g.kg-1)", style = "cont",  breaks = c(0,5,10,15,20,25))+
  tm_shape(limite)+
  tm_polygons(col = "black", alpha = 0, border.col="black")+
  tm_compass(position = c("right", "top"), size=4) +
  tm_grid(alpha = 0.2, labels.size = 1, labels.rot = c(0,90), n.x=3, n.y=3) + 
  tm_scale_bar(position = c("right", "bottom"), text.size =1) +
  tm_layout(title = "", legend.position = c("left", "top"), main.title.position = 'center', legend.text.size = 1)


tm_shape(raster) +
  tm_rgb(r=1, g=2, b=3)+
  tm_shape(limite)+
  tm_polygons(col = "black", alpha = 0, border.col="black")+
  tm_compass(position = c("right", "top"), size=4) +
  tm_grid(alpha = 0.2, labels.size = 1, labels.rot = c(0,90), n.x=3, n.y=3) + 
  tm_scale_bar(position = c("right", "bottom"), text.size =1) +
  tm_layout(title = "", legend.position = c("left", "top"), main.title.position = 'center', legend.text.size = 1)
```

### Se voc√™ chegou at√© aqui muito bem !!!! üëèüëèüëè

# Refer√™ncias