---
title: Geoestat√≠stica aplicada a agricultura de precis√£o
author:
  - admin
date: 'r Sys.Date()'
slug: geo
categories:
  - R
  - Programa√ß√£o
  - Geoestat√≠stica
tags:
  - Agricultura de Precis√£o
  - Mapping
  - Geoestat√≠stica
  - DSM
subtitle: 'Geoestat√≠stica aplicada ao mapeamento da fertilidade do solo'
summary: 'Um exemplo de aplica√ß√£o de geoestat√≠stica usando o R'
authors: []
lastmod: '2022-08-20T12:22:36-03:00'
featured: no
draft: no
image:
  caption: 'Image credit: [**Elias**](https://www.instagram.com/eliasmendescosta/)'
  focal_point: ""
  placement: 3
  preview_only: no
math: true
projects:
  - Bahia
bibliography: references.bib
csl: geoderma-regional.csl
---



<div id="introdu√ß√£o" class="section level1">
<h1>Introdu√ß√£o</h1>
<p>A geoestat√≠stica como conhecemos hoje come√ßou com os trabalhos de <span class="citation">Krige (<a href="#ref-Krige1951" role="doc-biblioref">1951</a>)</span>. Para ele somente a informa√ß√£o dada pela vari√¢ncia n√£o seria suficiente para explicar o fen√¥meno em estudo. Para tal, seria necess√°rio levar em considera√ß√£o a dist√¢ncia entre as observa√ß√µes. A partir da√≠ surge o conceito da <code>geoestat√≠stica</code>, que leva em considera√ß√£o a <code>localiza√ß√£o geogr√°fica</code> e a <code>depend√™ncia espacial</code> entre amostras.
<span class="citation">Matheron (<a href="#ref-Matheron1963" role="doc-biblioref">1963</a>)</span> e <span class="citation">Matheron (<a href="#ref-Matheron1971" role="doc-biblioref">1971</a>)</span> , baseado-se nas observa√ß√µes de Krige, desenvolveu a teoria das <code>vari√°veis regionalizadas</code>. Uma vari√°vel regionalizada √© uma fun√ß√£o num√©rica com distribui√ß√£o espacial, que varia de um ponto a outro com continuidade aparente, mas cujas varia√ß√µes n√£o podem ser representadas por uma fun√ß√£o matem√°tica simples.
A teoria das vari√°veis regionalizadas pressup√µe que a varia√ß√£o de uma vari√°vel pode ser expressa pela soma de tr√™s componentes: a) uma componente estrutural, associada a um valor m√©dio constante ou a uma tend√™ncia constante; b) uma componente aleat√≥ria, espacialmente correlacionada; e c) um ru√≠do aleat√≥rio ou erro residual.
Assim um valor da vari√°vel Z em um local x √© dado por:</p>
<p><span class="math display">\[ Z(x)=m(x)+\varepsilon‚Ä≤(x)+\varepsilon‚Ä≤‚Ä≤ \]</span>
onde: m(<strong>x</strong>) √© uma fun√ß√£o determin√≠stica que descreve a componente estrutural de Z
em x; Œµ‚Ä≤(<strong>x</strong>) √© um termo estoc√°stico, que varia localmente e depende espacialmente de
m(<strong>x</strong>); Œµ‚Ä≤‚Ä≤ √© um ru√≠do aleat√≥rio n√£o correlacionado, com distribui√ß√£o normal com
m√©dia zero e vari√¢ncia œÉ2</p>
<p>Um dos modelos mais simplistas dessa varia√ß√£o √© o calculado pelo <code>inverso do quadrado da dist√¢ncia</code> que assume que qualquer atributo do solo varia a taxa fixa do inverso da dist√¢ncia, o que na pr√°tica n√£o √© bem verdade, mas em muitos casos esse modelo atende a necessidade.</p>
<div id="variograma" class="section level2">
<h2>Variograma</h2>
<p>O variograma √© uma ferramenta b√°sica de suporte √†s t√©cnicas de krigagem, que permite representar quantitativamente a varia√ß√£o de um fen√¥meno regionalizado no espa√ßo. Considere duas vari√°veis regionalizadas, X e Y, onde X = Z(x) e Y = Z(x+h). Neste caso, referem-se ao mesmo atributo medido em duas posi√ß√µes diferentes.</p>
<p>O n√≠vel de depend√™ncia entre essas duas vari√°veis regionalizadas, X e Y, √© representado pelo variograma, 2Œ≥(<strong>h</strong>), o qual √© definido como a esperan√ßa matem√°tica do quadrado da diferen√ßa entre os valores de pontos no espa√ßo, separados pelo vetor dist√¢ncia <strong>h</strong>, isto √©,</p>
<p><span class="math display">\[ 2Œ≥(h) = E{[Z(x)-Z(x+h)] 2 } = Var[Z(x)-Z(x+h)]\]</span>
Atrav√©s de uma amostra z(x i ), i=1, 2, /home/elias/MEGA/Geo., n, o variograma pode ser estimado por</p>
<p><span class="math display">\[ 2≈∂(h)=\frac{1}{N(h)}\sum^{N(h)}_{i=1}[Z(x_i)-Z(X_i+h)]¬≤\]</span>
onde:
- 2≈∂(<strong>h</strong>) - √© o variograma estimado;
- N(h) - √© o n√∫mero de pares de valores medidos, z(<strong>xi</strong>) e z(<strong>xi+h</strong>), separados por um vetor dist√¢ncia <strong>h</strong>;
- z(xi) e z(xi +h), - s√£o valores da i-√©sima observa√ß√£o da vari√°vel regionalizada, coletados nos pontos <strong>xi</strong> e <strong>xi+h</strong> (i = 1, /home/elias/MEGA/Geo., n), separados pelo vetor <strong>h</strong>.</p>
</div>
<div id="par√¢metros-do-semivariograma" class="section level2">
<h2>Par√¢metros do semivariograma</h2>
<p>O seu padr√£o representa o que, intuitivamente, se espera de dados de campo, isto √©, que as diferen√ßas {Z(<strong>xi</strong>) - Z(<strong>xi+h</strong>)} decres√ßam √† medida que <strong>h</strong>, a dist√¢ncia que os separa decresce. √â esperado que observa√ß√µes mais pr√≥ximas geograficamente tenham um comportamento mais semelhante entre si do que aquelas separadas por maiores dist√¢ncias. Desta maneira, √© esperado que Œ≥(<strong>h</strong>) aumente com a dist√¢ncia <strong>h</strong>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:variogram"></span>
<img src="semivariograma.png" alt="Exemplo de Semivariograma." width="564" />
<p class="caption">
Figure 1: Exemplo de Semivariograma.
</p>
</div>
<ul>
<li>Alcance (a) (range): dist√¢ncia dentro da qual as amostras apresentam-se correlacionadas espacialmente.</li>
<li>Patamar (C) (sill): √© o valor do semivariograma correspondente a seu alcance (a).Deste ponto em diante, considera-se que n√£o existe mais depend√™ncia espacial entre as amostras, porque a vari√¢ncia da diferen√ßa entre pares de amostras (Var[Z(<strong>x</strong>) - Z(<strong>x+h</strong>)]) torna-se invariante com a dist√¢ncia. Pode ser definido tamb√©m como vari√¢ncia total.</li>
<li>Efeito Pepita (C0)(nugget): A medida que <strong>h</strong> tende para 0 (zero), g(<strong>h</strong>) se aproxima de um valor positivo chamado Efeito Pepita (C0), que revela a descontinuidade do semivariograma para dist√¢ncias menores do que a menor dist√¢ncia entre as amostras, pode ser definido tamb√©m como vari√¢ncia residual.</li>
</ul>
</div>
<div id="estrutura-espacial-local" class="section level2">
<h2>Estrutura espacial local</h2>
<p>Se consideramos as coordenadas de cada ponto √© poss√≠vel obervar uma tend√™ncia regional ou uma estrutura local dos dados, umas das formas mais simples de observar a depend√™ncia espacial √© atraves de plot espacial dos valores observados.</p>
<p>Agora analisamos a ideia de depend√™ncia espacial local: ‚Äúmais perto no espa√ßo geogr√°fico implica mais perto no espa√ßo de atributos‚Äù. Isso pode ser verdade ou n√£o;e se for verdade, o intervalo de depend√™ncia ir√° variar, dependendo do processo f√≠sico que produziu o atributo que est√° sendo investigado, nesse caso o teor de argila do solo.
O conceito fundamental √© que deve ser entendido nesse contexto √© a <code>autocorrela√ß√£o espacial</code>: um valor de atributo pode ser correlacionado consigo mesmo, com a for√ßa da correla√ß√£o dependendo da dist√¢ncia de separa√ß√£o (e possivelmente na dire√ß√£o). Isso deve ser evidente como uma rela√ß√£o entre a dist√¢ncia de separa√ß√£o e correla√ß√£o; para an√°lisar essas rela√ß√µes usamos o conceito de <code>semivari√¢ncia</code> como j√° mencionado quando apresentado o semivariograma.Esse an√°lise √© feita com base no n√∫mero de pares poss√≠veis do dataset que pode ser determinado por (n √ó (n - 1))/2 pares.</p>
<p>Quando fazemos o variograma experimental dos teores de COT, √© calculado as semivari√¢ncias <em>m√©dias</em> dos pares de pontos versus dist√¢ncia <em>m√©dia</em>(tamb√©m conhecido como ‚Äúlag‚Äù), com cumprimento definido pelo usu√°rio, e dist√¢ncia m√°xima de busca <em>cutoff</em>.</p>
</div>
<div id="modelos-te√≥ricos" class="section level2">
<h2>Modelos te√≥ricos</h2>
<p>Selecionar uma forma de modelo √© uma arte; a melhor maneira √© a partir do conhecimento do processo espacial e da forma como o modelo se ajusta ao semivariograma esperimental.
A fun√ß√£o vgm especifica um modelo de variograma. No conjunto anterior n√≥s estimamos esses par√¢metros observando o variograma emp√≠rico, ent√£o os fornecemos como par√¢metros do modelo. Observe que para cada modelo h√° um conjunto de par√¢metro que melhor se ajusta. Para fins de exemplo vamos testar os 3 principais modelos, neles teremos que ajustar o ‚Äúparcial sill‚Äù (contribui√ß√£o) <code>psill</code> que √© o patamar menos o efeito pepita (nugget) e o alcance (range)
Poss√≠veis modelos no pacote <code>gstat</code></p>
<pre class="r"><code>library(gstat)
library(sp)
library(readxl)
library(tmap)
library(raster)
print(show.vgms())</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>data &lt;- read_excel(&quot;/home/elias/MEGA/Geo/data/An√°lises.xls&quot;, 
                       col_types = c(&quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, 
                                     &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, 
                                     &quot;numeric&quot;, &quot;numeric&quot;, &quot;numeric&quot;, 
                                     &quot;numeric&quot;))

## Definindo o sistema de projeto do conjunto de dados
WGS23S  = sp::CRS(&quot;+proj=utm +zone=23 +south +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0&quot;)

## Transformando o dataframe &quot;data&quot; em informa√ß√£o espacial
coordinates(data) = ~X+Y
sp::proj4string(data) = WGS23S ## Definindo sistema de coordenadas para os DADOS

plot(data)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-1.png" width="672" /></p>
<pre class="r"><code>## Carregando arquivo raster para uso como grid de refer?ncia na interpola√ß√£o
raster=raster::brick(&quot;/home/elias/MEGA/Geo/raster/mosaico.tif&quot;)
#plotRGB(raster, 1, 2, 3)
sp::proj4string(raster) = WGS23S 
#raster=projectRaster(raster, crs = WGS23S)
#plot(raster)
## Transformando o arquivo &quot;raster&quot; em arquivo &quot;SpatialPixelsDataFrame&quot; para posterior uso como grid de refer√™ncia
grid=as(raster, &quot;SpatialPixelsDataFrame&quot;)

############### Analisando de forma qualitativa a deped√™ncia espacial)
plot(data, asp=1, cex=4*data$ADT/max(data$ADT), pch=1)</code></pre>
<pre><code>## Warning in max(data$ADT): no non-missing arguments to max; returning -Inf</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-2.png" width="672" /></p>
<pre class="r"><code>#############
# Aqui vamos ver de forma detalhada e did√°tica (passo a passo) da avalia√ß√£o de deped√™ncia espacial. Na pr√°tica n√£o h√° necessidade de seguir todos esses passos. 

n &lt;- length(data$COT) # comprimento do conjunto de dados
n*(n-1)/2  ## Calculando o n√∫mero de pares de pontos</code></pre>
<pre><code>## [1] 903</code></pre>
<pre class="r"><code># Agora como exerc√≠cio vamos calcular a semivari√¢ncia entre os dois primeiros pontos do dataset
coordinates(data)[1,] # linha 1</code></pre>
<pre><code>##       X       Y 
##  634733 7481375</code></pre>
<pre class="r"><code>coordinates(data)[2,] # linha 2</code></pre>
<pre><code>##       X       Y 
##  634745 7481350</code></pre>
<pre class="r"><code>sep &lt;- dist(coordinates(data)[1:2,]) # dist√¢ncia entre o ponto 1 e ponto 2
gamma &lt;- 0.5 * (data$ADT[1] - data$ADT[2])^2 # semivari√¢ncia entre o ponto 1 e ponto 2

max(dist(data@coords))*2/3 # M√°xima dist√¢ncia entre os pontos, para limitar a dist√¢ncia do variograma em 2/3 da M√°xima dist√¢ncia</code></pre>
<pre><code>## [1] 188.4203</code></pre>
<pre class="r"><code>min(dist(data@coords)) # minima dist√¢ncia entre pontos, ajuda a definir o tamanho do lag</code></pre>
<pre><code>## [1] 11.40175</code></pre>
<pre class="r"><code># Variograma de n√∫vem
variograma &lt;- gstat::variogram(COT ~ 1, data, cloud = TRUE, cutoff = Inf)
plot(variograma, ylab = &quot;semivari√¢ncia&quot;, xlab = &quot;dist√¢ncia (m)&quot;)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-3.png" width="672" /></p>
<pre class="r"><code># Variograma experimental
v &lt;- variogram(COT ~ 1, data, cutoff=90, width=7)
print(plot(v, plot.numbers=F))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-4.png" width="672" /></p>
<pre class="r"><code># width √© o tamanho do lag (passo), ou seja, um ponto m√©dio (uma simplifica√ß√£o) a cada 1800 m
# Cutoff = dist√¢ncia M√°xima de busca que a gente viu em 2/3 √© em torno de 70000 m, mas vimos que uma dist√¢ncia mais curta √© melhor ent√£o usamos 11000


####### Alguns exemplos de poss√≠veis modelos dispon√≠veis em R #####
print(show.vgms())</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-5.png" width="672" /></p>
<pre class="r"><code>### Modelo esf√©rico
vm1 &lt;- vgm(psill=15, model=&quot;Sph&quot;,range=40,nugget=0)
print(plot(v, pl=F, model=vm1, main = &quot;Esf√©rico&quot;))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-6.png" width="672" /></p>
<pre class="r"><code>### Modelo Exponencial
vm2 &lt;- vgm(psill=15, model=&quot;Exp&quot;,range=15,nugget=0)
print(plot(v, pl=F, model=vm2))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-7.png" width="672" /></p>
<pre class="r"><code>### Modelo Gaussiano
vm3 &lt;- vgm(psill=16, model=&quot;Gau&quot;,range=20,nugget=0)
print(plot(v, pl=F, model=vm3))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-8.png" width="672" /></p>
<pre class="r"><code># Modelo Ajustado esf√©rico
(vmf1 &lt;- fit.variogram(v, vm1))</code></pre>
<pre><code>## Warning in fit.variogram(v, vm1): No convergence after 200 iterations: try
## different initial values?</code></pre>
<pre><code>##   model    psill    range
## 1   Nug  0.00000  0.00000
## 2   Sph 14.66166 35.26004</code></pre>
<pre class="r"><code>print(plot(v, pl=F, model=vmf1))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-9.png" width="672" /></p>
<pre class="r"><code># Modelo Ajustado Exponencial
(vmf2 &lt;- fit.variogram(v, vm2))</code></pre>
<pre><code>##   model    psill    range
## 1   Nug  0.00000  0.00000
## 2   Exp 15.34669 14.71238</code></pre>
<pre class="r"><code>print(plot(v, pl=F, model=vmf2))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-10.png" width="672" /></p>
<pre class="r"><code># Modelo Gaussiano
(vmf3 &lt;- fit.variogram(v, vm3))</code></pre>
<pre><code>## Warning in fit.variogram(object, model, fit.sills = fit.sills, fit.ranges =
## fit.ranges, : No convergence after 200 iterations: try different initial values?</code></pre>
<pre><code>##   model    psill    range
## 1   Nug  0.00000  0.00000
## 2   Gau 14.59874 16.27831</code></pre>
<pre class="r"><code>print(plot(v, pl=F, model=vmf3))</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/lendo%20e%20plotando%20os%20dados-11.png" width="672" />
# krigagem
Agora usamos a estrutura espacial para interpolar ‚Äúde forma otimizada‚Äù para os locais n√£o amostrados. Existem muitas maneiras de interpolar; vamos primeiro investigar a krigagem ordin√°ria.
O que h√° de t√£o especial na krigagem?
‚Ä¢ Prev√™ em qualquer ponto como a m√©dia ponderada dos valores em pontos n√£o amostrados
‚Ä¢ Os pesos dados a cada ponto da amostra s√£o √≥timos, dado a estrutura de covari√¢ncia, conforme revelado pelo modelo de variograma (neste sentido o que √© ‚Äúmelhor‚Äù se ajutou)
‚Ä¢ A varia√ß√£o de krigagem em cada ponto √© gerada automaticamente como parte do processo de c√°lculo dos pesos.</p>
</div>
<div id="krigagem-ordin√°ria" class="section level2">
<h2>Krigagem ordin√°ria</h2>
<p>Antes de fazer as predi√ß√µes nos grids para gera√ß√£o dos mapas vamos fazer as predi√ß√µes no conjunto de dados de valida√ß√£o para avaliar o desempenho dos modelos.</p>
<pre class="r"><code>### Krigando no grid para gera√ß√£o do mapa
## Carregando o limite da √°rea no formato shapefile
limite &lt;- maptools::readShapeSpatial(&quot;/home/elias/MEGA/Geo/shape/limite.shp&quot;, 
                                     proj4string=WGS23S, verbose=TRUE)</code></pre>
<pre><code>## Warning: readShapeSpatial is deprecated; use rgdal::readOGR or sf::st_read</code></pre>
<pre><code>## Shapefile type: PolygonZ, (15), # of Shapes: 1</code></pre>
<pre><code>## Warning: readShapePoly is deprecated; use rgdal::readOGR or sf::st_read</code></pre>
<pre><code>## Shapefile type: PolygonZ, (15), # of Shapes: 1</code></pre>
<pre class="r"><code>### Predic√£o Exp
grid &lt;- krige(COT ~ 1, locations=data, newdata=grid, model=vm3)</code></pre>
<pre><code>## [using ordinary kriging]</code></pre>
<pre class="r"><code>grid &lt;- raster::stack(grid)
grid = raster::mask(grid, limite)
raster = raster::mask(raster, limite)

tm_shape(limite)+
  tm_polygons(col = &quot;lightgrey&quot;)+
  tm_shape(data) +
  tm_symbols(col = &quot;COT&quot;, palette = &#39;YlOrRd&#39;, size = &quot;COT&quot;, scale = 1.5,
             legend.size.show = F,    # comment this line to see the original size legend
             legend.col.show = T,     # comment this line to see the original color legend
             title.col=&quot;AWC (mm)&quot;) +
  tm_compass(position = c(&quot;center&quot;, &quot;top&quot;), size=4) +
  tm_grid(alpha = 0.2, labels.size = 1, labels.rot = c(0,90), n.x=5, n.y=6) + 
  tm_scale_bar(position = c(&quot;right&quot;, &quot;bottom&quot;), text.size =1) +
  tm_layout(title = &quot;&quot;, legend.position = c(&quot;left&quot;, &quot;top&quot;), main.title.position = &#39;center&#39;, legend.text.size = 1)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/kriging-1.png" width="672" /></p>
<pre class="r"><code>tm_shape(grid$var1.pred) +
  tm_raster(title = &quot;COT (g.kg-1)&quot;, style = &quot;cont&quot;,  breaks = c(0,5,10,15,20,25))+
  tm_shape(limite)+
  tm_polygons(col = &quot;black&quot;, alpha = 0, border.col=&quot;black&quot;)+
  tm_compass(position = c(&quot;right&quot;, &quot;top&quot;), size=4) +
  tm_grid(alpha = 0.2, labels.size = 1, labels.rot = c(0,90), n.x=3, n.y=3) + 
  tm_scale_bar(position = c(&quot;right&quot;, &quot;bottom&quot;), text.size =1) +
  tm_layout(title = &quot;&quot;, legend.position = c(&quot;left&quot;, &quot;top&quot;), main.title.position = &#39;center&#39;, legend.text.size = 1)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/kriging-2.png" width="672" /></p>
<pre class="r"><code>tm_shape(raster) +
  tm_rgb(r=1, g=2, b=3)+
  tm_shape(limite)+
  tm_polygons(col = &quot;black&quot;, alpha = 0, border.col=&quot;black&quot;)+
  tm_compass(position = c(&quot;right&quot;, &quot;top&quot;), size=4) +
  tm_grid(alpha = 0.2, labels.size = 1, labels.rot = c(0,90), n.x=3, n.y=3) + 
  tm_scale_bar(position = c(&quot;right&quot;, &quot;bottom&quot;), text.size =1) +
  tm_layout(title = &quot;&quot;, legend.position = c(&quot;left&quot;, &quot;top&quot;), main.title.position = &#39;center&#39;, legend.text.size = 1)</code></pre>
<p><img src="{{< blogdown/postref >}}index_files/figure-html/kriging-3.png" width="672" /></p>
<div id="se-voc√™-chegou-at√©-aqui-muito-bem" class="section level3">
<h3>Se voc√™ chegou at√© aqui muito bem !!!! üëèüëèüëè</h3>
</div>
</div>
</div>
<div id="refer√™ncias" class="section level1 unnumbered">
<h1>Refer√™ncias</h1>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-Krige1951" class="csl-entry">
Krige, D.G., 1951. A statistical approach to some basic mine valuation problems on the witwatersand. Journal of the Chemical, Metallurgical and Mining Society of South Africa 52, 119‚Äì139.
</div>
<div id="ref-Matheron1971" class="csl-entry">
Matheron, G., 1971. The theory of regionalized variables and its applications. Les Cahiers du Centre de Morphologie Mathematique in Fontainebleu, Paris 211.
</div>
<div id="ref-Matheron1963" class="csl-entry">
Matheron, G., 1963. Principles of geostatistics. Economic Geology 58, 1246‚Äì1266.
</div>
</div>
</div>
